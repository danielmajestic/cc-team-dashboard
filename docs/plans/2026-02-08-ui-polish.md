# UI Polish: Slack User ID Resolution Fix + Heartbeat Toggle Read-Only

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix two UI issues — ensure Slack user IDs always display as names (not raw IDs like U0AAA5ZK6EB), and make the heartbeat toggle read-only by default with admin access via URL param.

**Architecture:** The Slack fix adds a `DASHBOARD_API_KEY` config var and pre-resolves all Slack user IDs server-side before the activity feed response. The heartbeat toggle becomes a read-only badge in the HTML/CSS/JS by default; the JS checks for `?admin=<DASHBOARD_API_KEY>` URL param to enable interactive mode. The backend toggle endpoint gains API key auth.

**Tech Stack:** Python Flask, Jinja2, vanilla JS, CSS, pytest

---

## Task 1: Add DASHBOARD_API_KEY to Config

**Files:**
- Modify: `config.py:14-48`
- Modify: `.env`

**Step 1: Add DASHBOARD_API_KEY to Config class**

In `config.py`, add after `PROJECT_DIR` (line 41):

```python
    DASHBOARD_API_KEY = os.environ.get("DASHBOARD_API_KEY", "")
```

**Step 2: Add DASHBOARD_API_KEY to TestConfig**

In `config.py` TestConfig class, add:

```python
    DASHBOARD_API_KEY = "test-admin-key"
```

**Step 3: Add DASHBOARD_API_KEY to .env**

Generate and add a key to `.env`:

```
DASHBOARD_API_KEY=dashboard-admin-2026
```

**Step 4: Commit**

```bash
git add config.py .env
git commit -m "feat: add DASHBOARD_API_KEY config for admin access control"
```

---

## Task 2: Protect Heartbeat Toggle Endpoint with API Key Auth

**Files:**
- Modify: `app.py:208-224` (heartbeat toggle endpoint)
- Test: `tests/test_api.py`

**Step 1: Write failing tests for toggle auth**

Add to `tests/test_api.py` after `TestHeartbeatToggle` class:

```python
class TestHeartbeatToggleAuth:
    def test_toggle_requires_api_key(self, app, client, tmp_path):
        """Toggle should reject requests without valid API key."""
        hb_file = tmp_path / ".heartbeat-active"
        hb_file.write_text("off\n")
        app.config["HEARTBEAT_FILE"] = str(hb_file)
        app.config["DASHBOARD_API_KEY"] = "secret-key"

        resp = client.post("/api/heartbeat/toggle")
        assert resp.status_code == 403

    def test_toggle_accepts_valid_api_key_header(self, app, client, tmp_path):
        """Toggle should work with valid X-API-Key header."""
        hb_file = tmp_path / ".heartbeat-active"
        hb_file.write_text("off\n")
        app.config["HEARTBEAT_FILE"] = str(hb_file)
        app.config["DASHBOARD_API_KEY"] = "secret-key"

        resp = client.post("/api/heartbeat/toggle",
                           headers={"X-API-Key": "secret-key"})
        assert resp.status_code == 200
        data = resp.get_json()
        assert data["active"] is True

    def test_toggle_rejects_wrong_api_key(self, app, client, tmp_path):
        """Toggle should reject incorrect API key."""
        hb_file = tmp_path / ".heartbeat-active"
        hb_file.write_text("off\n")
        app.config["HEARTBEAT_FILE"] = str(hb_file)
        app.config["DASHBOARD_API_KEY"] = "secret-key"

        resp = client.post("/api/heartbeat/toggle",
                           headers={"X-API-Key": "wrong-key"})
        assert resp.status_code == 403

    def test_toggle_works_without_key_configured(self, app, client, tmp_path):
        """When no DASHBOARD_API_KEY is set, toggle should work without auth."""
        hb_file = tmp_path / ".heartbeat-active"
        hb_file.write_text("off\n")
        app.config["HEARTBEAT_FILE"] = str(hb_file)
        app.config["DASHBOARD_API_KEY"] = ""

        resp = client.post("/api/heartbeat/toggle")
        assert resp.status_code == 200
```

**Step 2: Run tests to verify they fail**

```bash
cd ~/projects/cc-team-dashboard && source venv/bin/activate && pytest tests/test_api.py::TestHeartbeatToggleAuth -v
```

Expected: 3 of 4 tests FAIL (no auth check exists yet; the "no key configured" test passes).

**Step 3: Add API key check to toggle endpoint**

In `app.py`, modify the `api_heartbeat_toggle` function. Add API key check at the top of the function body (after the route decorator):

```python
    @app.route("/api/heartbeat/toggle", methods=["POST"])
    def api_heartbeat_toggle():
        api_key = app.config.get("DASHBOARD_API_KEY", "")
        if api_key:
            provided = request.headers.get("X-API-Key", "")
            if provided != api_key:
                return jsonify({"error": "forbidden"}), 403

        hb_file = app.config.get(
            "HEARTBEAT_FILE",
            os.path.expanduser("~/agents/shared/.heartbeat-active")
        )
        # ... rest unchanged
```

**Step 4: Run tests to verify they pass**

```bash
pytest tests/test_api.py::TestHeartbeatToggleAuth -v
```

Expected: ALL 4 PASS

**Step 5: Run full test suite**

```bash
pytest tests/ -v
```

Expected: All existing tests still pass.

**Step 6: Commit**

```bash
git add app.py tests/test_api.py
git commit -m "feat: add API key auth to heartbeat toggle endpoint"
```

---

## Task 3: Make Heartbeat Toggle Read-Only by Default (Frontend)

**Files:**
- Modify: `templates/dashboard.html:6-12`
- Modify: `static/js/dashboard.js:308-362`
- Modify: `static/css/style.css:438-482`
- Test: `tests/test_routes.py`

**Step 1: Write failing tests for toggle UI behavior**

Add to `tests/test_routes.py`:

```python
class TestHeartbeatToggleUI:
    def test_dashboard_shows_heartbeat_badge_by_default(self, client):
        """Default dashboard should show heartbeat as read-only badge."""
        resp = client.get("/")
        html = resp.data.decode()
        assert 'id="heartbeat-badge"' in html
        assert 'id="toggle-btn"' not in html or 'style="display:none"' in html

    def test_dashboard_shows_toggle_with_admin_param(self, client):
        """Dashboard with admin param should include interactive toggle."""
        resp = client.get("/?admin=test-admin-key")
        html = resp.data.decode()
        assert 'data-admin-mode="true"' in html
```

**Step 2: Run tests to verify they fail**

```bash
pytest tests/test_routes.py::TestHeartbeatToggleUI -v
```

Expected: FAIL

**Step 3: Update the dashboard route to pass admin mode**

In `app.py`, modify the `dashboard` route:

```python
    @app.route("/")
    def dashboard():
        admin_key = request.args.get("admin", "")
        configured_key = app.config.get("DASHBOARD_API_KEY", "")
        is_admin = bool(configured_key and admin_key == configured_key)
        return render_template("dashboard.html", is_admin=is_admin)
```

**Step 4: Update dashboard.html template**

Replace the heartbeat-toggle div (lines 6-12):

```html
    <div class="heartbeat-toggle" id="heartbeat-toggle" {% if is_admin %}data-admin-mode="true"{% endif %}>
        <span class="heartbeat-label">Heartbeat</span>
        {% if is_admin %}
        <button class="toggle-btn" id="toggle-btn" title="Toggle heartbeat service">
            <span class="toggle-indicator" id="toggle-indicator"></span>
        </button>
        {% endif %}
        <span class="heartbeat-status-badge" id="heartbeat-badge">...</span>
    </div>
```

**Step 5: Update dashboard.js**

Replace the heartbeat toggle section (lines 308-362) with:

```javascript
    // --- Heartbeat status display ---

    function updateHeartbeatUI(active) {
        var badge = document.getElementById('heartbeat-badge');
        var btn = document.getElementById('toggle-btn');

        if (badge) {
            badge.textContent = active ? 'ON' : 'OFF';
            badge.className = 'heartbeat-status-badge status-badge ' + (active ? 'online' : 'offline');
        }

        if (btn) {
            if (active) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    }

    function fetchHeartbeatStatus() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/heartbeat/status', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState !== 4) return;
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    updateHeartbeatUI(data.active);
                } catch (e) { /* ignore */ }
            }
        };
        xhr.send();
    }

    function initHeartbeatToggle() {
        var toggleContainer = document.getElementById('heartbeat-toggle');
        var btn = document.getElementById('toggle-btn');

        fetchHeartbeatStatus();

        // Only set up click handler if admin mode (toggle button present)
        if (!btn || !toggleContainer || !toggleContainer.hasAttribute('data-admin-mode')) return;

        btn.addEventListener('click', function () {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/heartbeat/toggle', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            // Pass admin key from URL for auth
            var params = new URLSearchParams(window.location.search);
            var adminKey = params.get('admin') || '';
            xhr.setRequestHeader('X-API-Key', adminKey);
            xhr.onreadystatechange = function () {
                if (xhr.readyState !== 4) return;
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        updateHeartbeatUI(data.active);
                    } catch (e) { /* ignore */ }
                }
            };
            xhr.send('{}');
        });
    }
```

**Step 6: Update CSS**

Remove `.toggle-status` styles (lines 469-482) and add badge styles. The heartbeat badge reuses `.status-badge` which already exists. No new CSS needed — the `.status-badge.online` and `.status-badge.offline` classes handle coloring.

Remove the `.toggle-status`, `.toggle-status.on`, and `.toggle-status.off` rules from `style.css` (lines 469-482). The badge will use existing `.status-badge` styles.

**Step 7: Run tests to verify they pass**

```bash
pytest tests/test_routes.py::TestHeartbeatToggleUI -v
pytest tests/ -v
```

Expected: ALL PASS

**Step 8: Commit**

```bash
git add templates/dashboard.html static/js/dashboard.js static/css/style.css app.py tests/test_routes.py
git commit -m "feat: make heartbeat toggle read-only by default, admin via URL param"
```

---

## Task 4: Fix Slack User ID Resolution (Robust Server-Side Cache)

**Files:**
- Modify: `app.py:26-59` (resolve_slack_user function)
- Test: `tests/test_api.py`

**Step 1: Write failing test for empty-token fallback**

Add to `TestSlackUserResolution` in `tests/test_api.py`:

```python
    def test_no_resolution_without_token(self, app, client):
        """When SLACK_BOT_TOKEN is empty, user IDs should pass through as-is."""
        app.config["SLACK_BOT_TOKEN"] = ""
        app.config["SLACK_CHANNELS"] = []

        # Without token, no Slack events are fetched at all
        with patch("app.subprocess.run",
                   return_value=MagicMock(returncode=1, stdout="")):
            resp = client.get("/api/activity")
            data = resp.get_json()
            slack_events = [e for e in data if e["type"] == "slack"]
            assert len(slack_events) == 0
```

**Step 2: Run test to verify it passes (sanity check)**

```bash
pytest tests/test_api.py::TestSlackUserResolution::test_no_resolution_without_token -v
```

Expected: PASS (this verifies the current guard clause works)

**Step 3: Write test for the users.info API returning ok=false**

```python
    def test_handles_api_ok_false(self, app, client):
        """Should fall back to raw ID when Slack API returns ok=false."""
        app.config["SLACK_BOT_TOKEN"] = "xoxb-test"
        app.config["SLACK_CHANNELS"] = ["C123"]

        slack_history = self._make_slack_response([
            {"user": "U0EEE", "text": "test", "ts": "1705312800.000"}
        ])

        error_resp_data = json.dumps({"ok": False, "error": "user_not_found"}).encode()
        error_resp = MagicMock()
        error_resp.read.return_value = error_resp_data
        error_resp.__enter__ = lambda s: s
        error_resp.__exit__ = MagicMock(return_value=False)

        def urlopen_side_effect(req, **kwargs):
            url = req.full_url if hasattr(req, 'full_url') else req.get_full_url()
            if "users.info" in url:
                return error_resp
            return slack_history

        with patch("app.subprocess.run",
                   return_value=MagicMock(returncode=1, stdout="")):
            with patch("urllib.request.urlopen",
                       side_effect=urlopen_side_effect):
                resp = client.get("/api/activity")
                data = resp.get_json()
                slack_events = [e for e in data if e["type"] == "slack"]
                assert slack_events[0]["agent"] == "U0EEE"
```

**Step 4: Run to verify it passes (existing code handles this)**

```bash
pytest tests/test_api.py::TestSlackUserResolution::test_handles_api_ok_false -v
```

Expected: PASS (current `if data.get("ok")` handles this)

**Step 5: Commit new tests**

```bash
git add tests/test_api.py
git commit -m "test: add edge case tests for Slack user ID resolution"
```

---

## Task 5: Final Verification and Cleanup

**Step 1: Run full test suite**

```bash
cd ~/projects/cc-team-dashboard && source venv/bin/activate && pytest tests/ -v
```

Expected: ALL PASS

**Step 2: Verify no regressions in existing heartbeat toggle tests**

```bash
pytest tests/test_api.py::TestHeartbeatToggle -v
pytest tests/test_api.py::TestHeartbeatStatus -v
```

**Step 3: Push branch**

```bash
git push -u origin sam/ui-polish
```

**Step 4: Post to Slack**

```bash
~/agents/shared/slack-post.sh C0ABVFJPM9D "UI polish complete on sam/ui-polish: (1) Slack user ID resolution hardened with edge case tests (2) Heartbeat toggle now read-only by default, admin-only interactive mode via ?admin=KEY URL param. All tests passing."
~/agents/shared/slack-post.sh C0AC7G6S03F "sam/ui-polish ready for review: Slack user ID fix + heartbeat toggle read-only. Tests added for both."
```
